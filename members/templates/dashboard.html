<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>

    <!-- âœ… CHART JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- âœ… REMOVE FAVICON ERROR -->
    <link rel="icon" href="data:,">

<style>
    * {
        font-family: "Segoe UI", Arial, sans-serif;
        box-sizing: border-box;
    }

    body {
        margin: 0;
        background: radial-gradient(circle at top right, #1a1a1a, #000000);
        color: #ffffff;
        padding: 20px;
        min-height: 100vh;
    }

    .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 10px 0;
        border-bottom: 1px solid #333;
    }

   .profile {
    position: relative; /* âœ… REQUIRED */
    cursor: pointer;
    font-weight: 600;
    color: #ffdb05;
}

.dropdown {
    display: none;
    position: absolute;
    top: 42px;
    right: -70px;

    /* ðŸ”¥ HARD CLAMP */
    max-width: 180px;
    min-width: 160px;

    background: #1e1e1e;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    border: 1px solid #444;
    z-index: 1000;

    /* ðŸ”¥ PREVENT OVERFLOW */
    overflow: hidden;
}



    .dropdown div {
        padding: 12px;
        cursor: pointer;
        color: #ccc;
    }

    .dropdown div:hover {
        background: #2a2a2a;
        color: #ff8c00;
    }

    .actions button {
        padding: 12px 20px;
        margin-right: 10px;
        border-radius: 10px;
        border: none;
        background: linear-gradient(45deg, #ff8c00, #ffdb05);
        color: #000;
        font-weight: bold;
        cursor: pointer;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .card {
        background: #121212;
        padding: 25px;
        border-radius: 16px;
        border: 1px solid #2a2a2a;
    }

    .profit { color: #00ff88; }
    .loss { color: #ff4444; }

    .chart {
        background: #121212;
        padding: 30px;
        border-radius: 20px;
        border: 1px solid #333;
        max-width: 500px;
        margin: 0 auto 50px;
    }

    .month-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 20px;
    }

    .month-card {
        background: #181818;
        padding: 20px;
        border-radius: 16px;
        border-left: 4px solid #ff8c00;
        cursor: pointer;
    }

    #monthModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 999;
        align-items: center;
        justify-content: center;
    }

    .modal-box {
        background: #121212;
        width: 90%;
        max-width: 600px;
        border-radius: 24px;
        padding: 30px;
    }
</style>
</head>

<body>

<div class="topbar">
    <div class="profile" onclick="toggleProfile()">
        ðŸ‘¤ Profile
        <div class="dropdown" id="profileMenu">
            <div onclick="goProfile()">Edit Profile</div>
            <div onclick="logout()">Logout</div>
        </div>
    </div>
    <h2>Dashboard</h2>
</div>

<div class="actions">
    <button onclick="location.href='/add-member/'">Add Member</button>
    <button onclick="location.href='/members/'">View Members</button>
    <button onclick="location.href='/add-expense/'">Add Expense</button>
</div>

<div class="stats">
    <div class="card"><h4>Active Members</h4><p id="active">0</p></div>
    <div class="card"><h4>Expired Members</h4><p id="expired">0</p></div>
    <div class="card"><h4>Total Earnings</h4><p id="earning">â‚¹0</p></div>
    <div class="card"><h4>Total Expenses</h4><p id="expense">â‚¹0</p></div>
    <div class="card"><h4>Profit / Loss</h4><p id="profit">â‚¹0</p></div>
</div>

<div class="chart">
    <canvas id="moneyChart"></canvas>
</div>

<h3>Monthly Analytics</h3>
<div class="month-grid" id="monthlyExpenses"></div>

<script>
/* ðŸ”’ SESSION AUTH CHECK */
fetch("https://fitdesk.onrender.com/api/accounts/login/", {
    credentials: "include"
})
.then(res => {
    if (res.status === 401) {
        window.location.href = "/login.html";
    }
});

/* ðŸ‘¤ PROFILE DROPDOWN */
function toggleProfile() {
    const menu = document.getElementById("profileMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

/* âœ… CLOSE DROPDOWN ON OUTSIDE CLICK */
document.addEventListener("click", e => {
    if (!e.target.closest(".profile")) {
        const menu = document.getElementById("profileMenu");
        if (menu) menu.style.display = "none";
    }
});

function goProfile() {
    window.location.href = "/profile.html";
}

function logout() {
    fetch("https://fitdesk.onrender.com/api/accounts/logout/", {
        credentials: "include"
    }).finally(() => {
        window.location.href = "/login.html";
    });
}

/* ðŸ“Š DASHBOARD SUMMARY */
fetch("https://fitdesk.onrender.com/api/gym/dashboard-data/", {
    credentials: "include"
})
.then(res => {
    if (!res.ok) throw new Error("Auth failed");
    return res.json();
})
.then(data => {
    document.getElementById("active").innerText = data.active_members ?? 0;
    document.getElementById("expired").innerText = data.expired_members ?? 0;
})
.catch(() => {
    window.location.href = "/login.html";
});

/* ðŸ“ˆ CURRENT MONTH */
fetch("https://fitdesk.onrender.com/api/gym/current-month-summary/", {
    credentials: "include"
})
.then(res => res.json())
.then(data => {
    document.getElementById("earning").innerText = "â‚¹" + data.earning;
    document.getElementById("expense").innerText = "â‚¹" + data.expense;

    const profitEl = document.getElementById("profit");
    profitEl.innerText = "â‚¹" + data.profit;
    profitEl.className = data.profit >= 0 ? "profit" : "loss";

    new Chart(document.getElementById("moneyChart"), {
        type: "doughnut",
        data: {
            labels: ["Earnings", "Expenses"],
            datasets: [{
                data: [data.earning, data.expense],
                backgroundColor: ["#ffdb05", "#ff8c00"],
                cutout: "65%"
            }]
        }
    });
});

/* ðŸ“† MONTHLY ANALYTICS */
fetch("https://fitdesk.onrender.com/api/expenses/monthly-summary/", {
    credentials: "include"
})
.then(res => res.json())
.then(data => {
    const box = document.getElementById("monthlyExpenses");
    box.innerHTML = "";

    if (!data || data.length === 0) {
        box.innerHTML = "<p>No monthly data available</p>";
        return;
    }

    data.forEach(m => {
        box.innerHTML += `
            <div class="month-card">
                <h4>${m.month} ${m.year}</h4>
                <p>Earnings: â‚¹${m.earning}</p>
                <p>Expenses: â‚¹${m.expense}</p>
                <p style="color:${m.profit >= 0 ? '#00ff88' : '#ff4444'}">
                    ${m.profit >= 0 ? 'Profit' : 'Loss'}: â‚¹${Math.abs(m.profit)}
                </p>
            </div>
        `;
    });
});
</script>


</body>
</html>
